/**********************************************************************/
/*                                                                    */
/* Description: CH7033/34/35 set up code, realized by C code          */
/*                                                                    */
/*              1. Integrate this file to your project                */
/*                                                                    */
/*              2. Add realization of IIC read/write function         */
/*                                                                    */
/*              3. Call InitializeCH703X                              */
/*                                                                    */
/* Create By: CH7033/34/35 Program Tool Rev1.01.02                    */
/*                                                                    */
/* Create Date: 2010-12-19                                            */
/*                                                                    */
/**********************************************************************/
#include <div64.h>
#include <common.h>
//Chrontel type define: 
typedef unsigned long long	ch_uint64;
typedef unsigned int		ch_uint32;
typedef unsigned short		ch_uint16;
typedef unsigned char		ch_uint8;
typedef ch_uint32		ch_bool;
#define ch_true			1
#define ch_false		0

extern void i2c_send_bytes(unsigned char * out_buf, unsigned int len);
extern void i2c_rcv_bytes(unsigned char * in_buf, unsigned int len);

//IIC function: read/write CH7033
ch_uint32 I2CRead(ch_uint32 addr)
{
	//Realize this according to your system...
        unsigned char buf[2];
        buf[0] = addr;
        i2c_send_bytes(buf, 1); //S+DEVICE+W A RegAddr A        
        i2c_rcv_bytes(buf, 1);  //S+ DEVICE + R Data Byte High A Data Byte Low          
        return buf[0];

}
void I2CWrite(ch_uint32 addr, ch_uint32 value)
{
	//Realize this according to your system...
        unsigned char   out_buf[2];
        out_buf[0] = addr;
        out_buf[1] = value;
        i2c_send_bytes(out_buf, 2);

}
//////////////
/*
enum CH7033_MODE {
	CH7033_in_1024x768_out_VGA_1024x768,
	CH7033_in_1024x768_out_VGA_1280x1024,
	CH7033_in_1024x768_out_HDMI_1280x720,
	
};
*/
//CH7033_in_1024x768_out_VGA_1024x768
static ch_uint32 CH7033_in_1024x768_out_VGA_1024x768_RegTable[][2] = {
	{ 0x03, 0x04 },
	{ 0x52, 0x01 },
	{ 0x52, 0x03 },
	{ 0x03, 0x00 },
	{ 0x07, 0xD9 },
	{ 0x08, 0xF1 },
	{ 0x09, 0x03 },
	{ 0x0B, 0x2C },
	{ 0x0C, 0x00 },
	{ 0x0D, 0x29 },
	{ 0x0F, 0x02 },
	{ 0x10, 0x0A },
	{ 0x11, 0x1B },
	{ 0x12, 0x00 },
	{ 0x13, 0x84 },
	{ 0x15, 0x64 },
	{ 0x16, 0x05 },
	{ 0x19, 0xF8 },
	{ 0x1A, 0xFD },
	{ 0x1B, 0xE8 },
	{ 0x1C, 0x69 },
	{ 0x1D, 0x78 },
	{ 0x1E, 0xC0 },
	{ 0x1F, 0x2C },
	{ 0x20, 0x00 },
	{ 0x21, 0x40 },
	{ 0x25, 0x1B },
	{ 0x26, 0x00 },
	{ 0x27, 0x26 },
	{ 0x2E, 0x3D },
	{ 0x55, 0x18 },
	{ 0x56, 0x88 },
	{ 0x58, 0x03 },
	{ 0x59, 0x06 },
	{ 0x5A, 0x03 },
	{ 0x5B, 0x9C },
	{ 0x5C, 0x71 },
	{ 0x5D, 0xC7 },
	{ 0x5E, 0x54 },
	{ 0x64, 0x20 },
	{ 0x68, 0x46 },
	{ 0x6B, 0x60 },
	{ 0x70, 0x98 },
	{ 0x03, 0x01 },
	{ 0x08, 0x05 },
	{ 0x12, 0xD4 },
	{ 0x15, 0x00 },
	{ 0x23, 0xE3 },
	{ 0x28, 0x19 },
	{ 0x29, 0x64 },
	{ 0x6B, 0x11 },
	{ 0x03, 0x03 },
	{ 0x03, 0x04 },
	{ 0x11, 0xFD },
	{ 0x12, 0xE8 },
	{ 0x13, 0x02 },
	{ 0x14, 0x88 },
	{ 0x15, 0x70 },
	{ 0x54, 0xC4 },
	{ 0x55, 0x5B },
	{ 0x56, 0x4D },
	{ 0x61, 0x40 },
};

//////////CH7033_in_1024x768_out_VGA_1280x1024
static ch_uint32 CH7033_in_1024x768_out_VGA_1280x1024_RegTable[][2] = {
	{ 0x03, 0x04 },
	{ 0x52, 0x01 },
	{ 0x52, 0x03 },
	{ 0x03, 0x00 },
	{ 0x07, 0xD9 },
	{ 0x08, 0xF1 },
	{ 0x09, 0x03 },
	{ 0x0B, 0x2C },
	{ 0x0C, 0x00 },
	{ 0x0D, 0x29 },
	{ 0x0F, 0x02 },
	{ 0x10, 0x0A },
	{ 0x11, 0x1B },
	{ 0x12, 0x00 },
	{ 0x13, 0x84 },
	{ 0x15, 0x64 },
	{ 0x16, 0x05 },
	{ 0x19, 0xF8 },
	{ 0x1A, 0xFD },
	{ 0x1B, 0xE8 },
	{ 0x1C, 0x69 },
	{ 0x1D, 0x78 },
	{ 0x1E, 0xC0 },
	{ 0x1F, 0x35 },
	{ 0x20, 0x00 },
	{ 0x21, 0x98 },
	{ 0x25, 0x24 },
	{ 0x26, 0x00 },
	{ 0x27, 0x2A },
	{ 0x2E, 0x3D },
	{ 0x55, 0x30 },
	{ 0x56, 0x70 },
	{ 0x58, 0x01 },
	{ 0x59, 0x03 },
	{ 0x5A, 0x04 },
	{ 0x5E, 0x54 },
	{ 0x64, 0x20 },
	{ 0x68, 0x46 },
	{ 0x6B, 0x60 },
	{ 0x70, 0x98 },
	{ 0x03, 0x01 },
	{ 0x08, 0x05 },
	{ 0x12, 0xD6 },
	{ 0x13, 0x28 },
	{ 0x15, 0x00 },
	{ 0x23, 0xE3 },
	{ 0x28, 0x2A },
	{ 0x29, 0x30 },
	{ 0x6B, 0x11 },
	{ 0x03, 0x03 },
	{ 0x03, 0x04 },
	{ 0x10, 0x01 },
	{ 0x11, 0xA5 },
	{ 0x12, 0xE0 },
	{ 0x13, 0x02 },
	{ 0x14, 0x88 },
	{ 0x15, 0x70 },
	{ 0x54, 0xC4 },
	{ 0x55, 0x5B },
	{ 0x56, 0x4D },
	{ 0x61, 0x40 },
};
///
static ch_uint32 CH7033_in_1024x768_out_HDMI_1280x720_RegTable[][2] = {
	{ 0x03, 0x04 },
	{ 0x52, 0x01 },
	{ 0x52, 0x03 },
	{ 0x03, 0x00 },
	{ 0x07, 0x91 },
	{ 0x08, 0x0F },
	{ 0x09, 0x02 },
	{ 0x0B, 0x2C },
	{ 0x0C, 0x00 },
	{ 0x0D, 0x29 },
	{ 0x0F, 0x02 },
	{ 0x10, 0x0A },
	{ 0x11, 0x1B },
	{ 0x12, 0x00 },
	{ 0x13, 0x84 },
	{ 0x15, 0x64 },
	{ 0x16, 0x05 },
	{ 0x19, 0xF8 },
	{ 0x1A, 0xFD },
	{ 0x1B, 0xE8 },
	{ 0x1C, 0x69 },
	{ 0x1D, 0x78 },
	{ 0x1E, 0xC0 },
	{ 0x1F, 0x35 },
	{ 0x20, 0x00 },
	{ 0x21, 0x72 },
	{ 0x25, 0x12 },
	{ 0x26, 0xD0 },
	{ 0x27, 0xEE },
	{ 0x2E, 0x3D },
	{ 0x3D, 0x8A },
	{ 0x40, 0x04 },
	{ 0x55, 0x6E },
	{ 0x56, 0x28 },
	{ 0x58, 0x05 },
	{ 0x59, 0x05 },
	{ 0x5E, 0x54 },
	{ 0x64, 0x20 },
	{ 0x68, 0x42 },
	{ 0x6B, 0x60 },
	{ 0x70, 0x98 },
	{ 0x7E, 0x8F },
	{ 0x03, 0x01 },
	{ 0x08, 0x05 },
	{ 0x0B, 0x75 },
	{ 0x0C, 0x6A },
	{ 0x0D, 0x21 },
	{ 0x0F, 0x9D },
	{ 0x12, 0xD4 },
	{ 0x13, 0x28 },
	{ 0x14, 0x80 },
	{ 0x15, 0xE1 },
	{ 0x23, 0xE3 },
	{ 0x28, 0x1D },
	{ 0x29, 0x01 },
	{ 0x6B, 0x10 },
	{ 0x6C, 0x04 },
	{ 0x03, 0x03 },
	{ 0x03, 0x04 },
	{ 0x10, 0x01 },
	{ 0x11, 0x22 },
	{ 0x12, 0x0A },
	{ 0x13, 0x02 },
	{ 0x14, 0x88 },
	{ 0x15, 0x70 },
	{ 0x54, 0xC4 },
	{ 0x55, 0x5B },
	{ 0x56, 0x4D },
	{ 0x61, 0xC4 },
};

static ch_uint32 CH7033_in_1024x600_out_hdmi_1280x720_RegTable[][2] = {
	{ 0x03, 0x04 },
	{ 0x52, 0x01 },
	{ 0x52, 0x03 },
	{ 0x03, 0x00 },
	{ 0x07, 0x91 },
	{ 0x08, 0x0F },
	{ 0x09, 0x02 },
	{ 0x0B, 0x24 },
	{ 0x0C, 0x1E },
	{ 0x0D, 0x8E },
	{ 0x0F, 0x20 },
	{ 0x10, 0x40 },
	{ 0x11, 0x12 },
	{ 0x12, 0x58 },
	{ 0x13, 0x6C },
	{ 0x15, 0x05 },
	{ 0x16, 0x05 },
	{ 0x1A, 0xAF },
	{ 0x1B, 0xC8 },
	{ 0x1C, 0x69 },
	{ 0x1D, 0x78 },
	{ 0x1E, 0xC8 },
	{ 0x1F, 0x35 },
	{ 0x20, 0x00 },
	{ 0x21, 0x72 },
	{ 0x25, 0x12 },
	{ 0x26, 0xD0 },
	{ 0x27, 0xEE },
	{ 0x2E, 0x3D },
	{ 0x3D, 0x8A },
	{ 0x40, 0x04 },
	{ 0x55, 0x6E },
	{ 0x56, 0x28 },
	{ 0x58, 0x05 },
	{ 0x59, 0x05 },
	{ 0x5E, 0x54 },
	{ 0x68, 0x46 },
	{ 0x6B, 0x6A },
	{ 0x6C, 0x1E },
	{ 0x6E, 0xA8 },
	{ 0x7E, 0x8F },
	{ 0x03, 0x01 },
	{ 0x08, 0x05 },
	{ 0x0B, 0x75 },
	{ 0x0C, 0x6A },
	{ 0x0D, 0x21 },
	{ 0x0F, 0x9D },
	{ 0x12, 0xD4 },
	{ 0x13, 0x28 },
	{ 0x14, 0x80 },
	{ 0x15, 0xE1 },
	{ 0x1B, 0xA0 },
	{ 0x1C, 0x48 },
	{ 0x1D, 0x57 },
	{ 0x23, 0xE3 },
	{ 0x28, 0x1D },
	{ 0x29, 0x01 },
	{ 0x6B, 0x10 },
	{ 0x6C, 0x04 },
	{ 0x03, 0x03 },
	{ 0x28, 0x04 },
	{ 0x03, 0x04 },
	{ 0x10, 0x01 },
	{ 0x11, 0x22 },
	{ 0x12, 0x0A },
	{ 0x13, 0x02 },
	{ 0x14, 0x88 },
	{ 0x15, 0x70 },
	{ 0x54, 0xC4 },
	{ 0x55, 0x5B },
	{ 0x56, 0x4D },
	{ 0x61, 0xC4 },
	{ 0x7F, 0xFE },
};

static ch_uint32 CH7033_in_1024x600_out_hdmi_1920x1080_RegTable[][2] = {
	{ 0x03, 0x04 },
	{ 0x52, 0x01 },
	{ 0x52, 0x03 },
	{ 0x03, 0x00 },
	{ 0x07, 0x91 },
	{ 0x08, 0x0F },
	{ 0x09, 0x02 },
	{ 0x0B, 0x24 },
	{ 0x0C, 0x1E },
	{ 0x0D, 0x8E },
	{ 0x0F, 0x20 },
	{ 0x10, 0x40 },
	{ 0x11, 0x12 },
	{ 0x12, 0x58 },
	{ 0x13, 0x6C },
	{ 0x15, 0x05 },
	{ 0x16, 0x05 },
	{ 0x1A, 0xAF },
	{ 0x1B, 0xC8 },
	{ 0x1C, 0x69 },
	{ 0x1D, 0x78 },
	{ 0x1E, 0xC8 },
	{ 0x1F, 0x47 },
	{ 0x21, 0x98 },
	{ 0x25, 0x24 },
	{ 0x26, 0x38 },
	{ 0x27, 0x65 },
	{ 0x2E, 0x3D },
	{ 0x3D, 0x8A },
	{ 0x40, 0x10 },
	{ 0x55, 0x58 },
	{ 0x56, 0x2C },
	{ 0x58, 0x04 },
	{ 0x59, 0x05 },
	{ 0x5E, 0x54 },
	{ 0x68, 0x46 },
	{ 0x6B, 0x6A },
	{ 0x6C, 0x1E },
	{ 0x6E, 0xA8 },
	{ 0x7E, 0x8F },
	{ 0x03, 0x01 },
	{ 0x08, 0x05 },
	{ 0x0B, 0x75 },
	{ 0x0C, 0x74 },
	{ 0x0D, 0x21 },
	{ 0x0F, 0x9D },
	{ 0x12, 0xD6 },
	{ 0x13, 0x28 },
	{ 0x14, 0x80 },
	{ 0x15, 0xE1 },
	{ 0x1B, 0xF0 },
	{ 0x1C, 0x08 },
	{ 0x1D, 0x83 },
	{ 0x23, 0xE3 },
	{ 0x28, 0x3A },
	{ 0x29, 0x02 },
	{ 0x6B, 0x10 },
	{ 0x6C, 0x00 },
	{ 0x03, 0x03 },
	{ 0x28, 0x04 },
	{ 0x03, 0x04 },
	{ 0x10, 0x02 },
	{ 0x11, 0x44 },
	{ 0x12, 0x14 },
	{ 0x13, 0x02 },
	{ 0x14, 0x88 },
	{ 0x15, 0x70 },
	{ 0x54, 0xC4 },
	{ 0x55, 0x5B },
	{ 0x56, 0x4D },
	{ 0x61, 0xC4 },
	{ 0x7F, 0xFE },
};

/////////////
//#define REGTABLE_LEN	((sizeof(CH7033_RegTable))/(2*sizeof(ch_uint32)))

ch_bool InitializeCH7033(char* param)
{
	ch_uint32 i, val_t;
	ch_uint32 hinc_reg, hinca_reg, hincb_reg;
	ch_uint32 vinc_reg, vinca_reg, vincb_reg;
	ch_uint32 hdinc_reg, hdinca_reg, hdincb_reg;
	ch_uint32 REGTABLE_LEN = 0;

	ch_uint32 *CH7033_RegTable = NULL;
	
	printf("CH7033 Init ...\n");

	if(strcmp(param, "in_1024x768_out_hdmi_1280x720") == 0)
	{
		CH7033_RegTable = (ch_uint32*)CH7033_in_1024x768_out_HDMI_1280x720_RegTable;
		REGTABLE_LEN = (sizeof(CH7033_in_1024x768_out_HDMI_1280x720_RegTable))/(2*sizeof(ch_uint32));
	}
	else if(strcmp(param, "in_1024x768_out_vga_1024x768") == 0)
	{
		CH7033_RegTable = (ch_uint32*)CH7033_in_1024x768_out_VGA_1024x768_RegTable;
		REGTABLE_LEN = (sizeof(CH7033_in_1024x768_out_VGA_1024x768_RegTable))/(2*sizeof(ch_uint32));
	}
	else if(strcmp(param, "in_1024x768_out_vga_1280x1024") == 0)
	{
		CH7033_RegTable = (ch_uint32*)CH7033_in_1024x768_out_VGA_1280x1024_RegTable;
		REGTABLE_LEN = (sizeof(CH7033_in_1024x768_out_VGA_1280x1024_RegTable))/(2*sizeof(ch_uint32));
	}
	else if(strcmp(param, "in_1024x600_out_hdmi_1280x720") == 0)
	{
		CH7033_RegTable = (ch_uint32*)CH7033_in_1024x600_out_hdmi_1280x720_RegTable;
		REGTABLE_LEN = (sizeof(CH7033_in_1024x600_out_hdmi_1280x720_RegTable))/(2*sizeof(ch_uint32));
	//	printf("PL111 display==============\n");
	}
		else if(strcmp(param, "in_1024x600_out_hdmi_1920x1080") == 0)
	{
		CH7033_RegTable = (ch_uint32*)CH7033_in_1024x600_out_hdmi_1920x1080_RegTable;
		REGTABLE_LEN = (sizeof(CH7033_in_1024x600_out_hdmi_1920x1080_RegTable))/(2*sizeof(ch_uint32));
	}
	else
	{
		printf("Mode not supported by CH7033\n");
		return ch_false;
	}

	printf("Mode = %s\n", param);
	printf("PL111 display==============\n");

	i2c_master_init(0x76);	//or 76


	//1. write register table:
	for(i=0; i<REGTABLE_LEN; ++i)
	{
		//I2CWrite(CH7033_RegTable[i][0], CH7033_RegTable[i][1]);
		I2CWrite(CH7033_RegTable[2*i], CH7033_RegTable[2*i+1]);
	//	printf("CH7033 Reg[0x%x] = 0x%x\n",CH7033_RegTable[2*i],I2CRead(CH7033_RegTable[2*i]));
	}

	//2. Calculate online parameters:
	I2CWrite(0x03, 0x00);
	i = I2CRead(0x25);
	I2CWrite(0x03, 0x04);
	//HINCA:
	val_t = I2CRead(0x2A);
	hinca_reg = (val_t << 3) | (I2CRead(0x2B) & 0x07);
	//HINCB:
	val_t = I2CRead(0x2C);
	hincb_reg = (val_t << 3) | (I2CRead(0x2D) & 0x07);
	//VINCA:
	val_t = I2CRead(0x2E);
	vinca_reg = (val_t << 3) | (I2CRead(0x2F) & 0x07);
	//VINCB:
	val_t = I2CRead(0x30);
	vincb_reg = (val_t << 3) | (I2CRead(0x31) & 0x07);
	//HDINCA:
	val_t = I2CRead(0x32);
	hdinca_reg = (val_t << 3) | (I2CRead(0x33) & 0x07);
	//HDINCB:
	val_t = I2CRead(0x34);
	hdincb_reg = (val_t << 3) | (I2CRead(0x35) & 0x07);
	//no calculate hdinc if down sample disaled
	if(i & (1 << 6))
	{
		if(hdincb_reg == 0)
		{
			return ch_false;
		}
		//hdinc_reg = (ch_uint32)(((ch_uint64)hdinca_reg) * (1 << 20) / hdincb_reg);
		hdinc_reg = (ch_uint32)lldiv(((ch_uint64)hdinca_reg) * (1 << 20), hdincb_reg);
		I2CWrite(0x3C, (hdinc_reg >> 16) & 0xFF);
		I2CWrite(0x3D, (hdinc_reg >>  8) & 0xFF);
		I2CWrite(0x3E, (hdinc_reg >>  0) & 0xFF);
	}
	if(hincb_reg == 0 || vincb_reg == 0)
	{
		return ch_false;
	}
	if(hinca_reg > hincb_reg)
	{
		return ch_false;
	}
	//hinc_reg = (ch_uint32)((ch_uint64)hinca_reg * (1 << 20) / hincb_reg);
	hinc_reg = (ch_uint32)lldiv(((ch_uint64)hinca_reg) * (1 << 20), hincb_reg);
	//vinc_reg = (ch_uint32)((ch_uint64)vinca_reg * (1 << 20) / vincb_reg);
	vinc_reg = (ch_uint32)lldiv(((ch_uint64)vinca_reg) * (1 << 20), vincb_reg);
	I2CWrite(0x36, (hinc_reg >> 16) & 0xFF);
	I2CWrite(0x37, (hinc_reg >>  8) & 0xFF);
	I2CWrite(0x38, (hinc_reg >>  0) & 0xFF);
	I2CWrite(0x39, (vinc_reg >> 16) & 0xFF);
	I2CWrite(0x3A, (vinc_reg >>  8) & 0xFF);
	I2CWrite(0x3B, (vinc_reg >>  0) & 0xFF);

	//3. Start to running:
	I2CWrite(0x03, 0x00);
	val_t = I2CRead(0x0A);
	I2CWrite(0x0A, val_t | 0x80);
	I2CWrite(0x0A, val_t & 0x7F);
	val_t = I2CRead(0x0A);
	I2CWrite(0x0A, val_t & 0xEF);

	I2CWrite(0x0A, val_t | 0x10);

	I2CWrite(0x0A, val_t & 0xEF);

	printf("done\n");

	return ch_true;
}


